# 协作编辑器使用指南

## 快速开始

### 1. 启动服务器

首先需要启动后端 WebSocket 服务器：

```bash
# 在项目根目录运行
pnpm dev:backend
```

你会看到类似输出：
```
WebSocket 服务器运行在 ws://localhost:3001
连接格式: ws://localhost:3001/文档名
示例: ws://localhost:3001/demo-document-1
```

### 2. 启动前端应用

在另一个终端窗口启动前端：

```bash
# 在项目根目录运行
pnpm dev
```

或者同时启动前后端：

```bash
pnpm dev:all
```

### 3. 访问应用

打开浏览器访问：http://localhost:5173

点击 **"协作编辑器"** 标签页。

## 如何使用协作功能

### 基本使用

1. **确保后端服务器正在运行**
   - 检查终端是否有 "WebSocket 服务器运行在 ws://localhost:3001" 的提示
   - 如果看到 "连接错误"，说明后端未启动

2. **打开多个浏览器窗口/标签页**
   - 在同一个浏览器中打开多个标签页
   - 或者在不同浏览器中打开
   - 都访问 http://localhost:5173

3. **切换到协作编辑器**
   - 点击页面上的 **"协作编辑器"** 标签

4. **开始编辑**
   - 在一个标签页中输入内容
   - 在另一个标签页中会**实时看到**相同的内容
   - 多个用户可以同时编辑，所有更改会实时同步

### 功能说明

#### 协作信息面板

在编辑器下方会显示：
- **文档 ID**: 当前编辑的文档标识符（默认是 `demo-document-1`）
- **连接状态**: 
  - 🟢 **已连接**: 正常连接到服务器
  - 🔴 **未连接**: 后端服务器未启动
  - 🟡 **连接中...**: 正在尝试连接
  - 🔴 **连接错误**: 无法连接到服务器
- **在线用户数**: 当前有多少用户正在编辑这个文档

#### 协作光标

- 当其他用户正在编辑时，你会看到他们的**光标位置**
- 每个用户有不同的颜色标识
- 用户名显示为 "用户 XXX"（随机生成）

#### 实时同步

- ✅ 输入的文字会实时同步
- ✅ 格式化（粗体、斜体等）会实时同步
- ✅ 删除内容会实时同步
- ✅ 所有编辑操作都会立即同步到所有连接的客户端

## 测试协作功能

### 方法 1: 同一台电脑多个标签页

1. 启动后端：`pnpm dev:backend`
2. 启动前端：`pnpm dev`
3. 打开浏览器，访问 http://localhost:5173
4. 切换到 "协作编辑器" 标签
5. 按 `Cmd/Ctrl + T` 打开新标签页，再次访问相同地址
6. 在两个标签页中分别输入内容，观察实时同步

### 方法 2: 不同设备/浏览器

1. 确保后端服务器运行在可访问的地址
2. 修改前端代码中的 WebSocket 地址（如果需要）
3. 在不同设备上访问前端应用
4. 开始协作编辑

## 常见问题

### Q: 显示 "连接错误" 怎么办？

**A:** 检查以下几点：
1. 后端服务器是否正在运行？
   ```bash
   # 检查是否有进程在运行
   # 或者重新启动
   pnpm dev:backend
   ```
2. 端口 3001 是否被占用？
3. 浏览器控制台是否有错误信息？

### Q: 为什么看不到其他用户的光标？

**A:** 
- 确保后端服务器正在运行
- 确保连接状态显示为 "已连接"
- 确保有多个标签页/窗口同时打开并连接到同一个文档

### Q: 如何修改文档 ID？

**A:** 在 `TiptapEditorCollaboration.vue` 文件中找到：
```javascript
const documentId = ref("demo-document-1");
```
修改为你想要的文档名即可。**相同文档 ID 的用户会看到相同的内容**。

### Q: 如何修改 WebSocket 服务器地址？

**A:** 在 `TiptapEditorCollaboration.vue` 文件中找到：
```javascript
const WS_URL = "ws://localhost:3001";
```
修改为你的服务器地址。

### Q: 数据会保存吗？

**A:** 当前版本的数据只保存在内存中。关闭服务器后数据会丢失。如果需要持久化，需要：
1. 在后端添加数据库存储
2. 实现文档的保存和加载功能

## 工作原理

1. **Yjs**: 使用 Yjs 库管理文档状态，支持冲突解决
2. **WebSocket**: 通过 WebSocket 实时传输文档更新
3. **后端服务器**: 接收并转发所有客户端的更新
4. **协作扩展**: Tiptap 的 Collaboration 扩展将编辑器与 Yjs 绑定

## 下一步

- 添加用户认证
- 添加文档列表
- 添加文档持久化（数据库）
- 添加权限管理
- 添加评论功能

